# DataModule æ¯”è¼ƒåˆ†æï¼šTrafficDataModule vs DistributedTrafficDataModule

> é—œéµå·®ç•°è¨˜éŒ„æ–‡æª” - é¿å…æ··æ·†åŠŸèƒ½é‡è¤‡æ€§  
> å»ºç«‹æ—¥æœŸï¼š2025-08-02

## ğŸ¯ æ ¸å¿ƒå•é¡Œ

**å•é¡Œ**: DistributedTrafficDataModule è·Ÿ TrafficDataModule åŠŸèƒ½çœ‹èµ·ä¾†ä¸€æ¨£ï¼Ÿ  
**ç­”æ¡ˆ**: è¡¨é¢ç›¸ä¼¼ä½†æ¶æ§‹ç›®æ¨™å®Œå…¨ä¸åŒ

---

## ğŸ“Š è©³ç´°æ¯”è¼ƒ

### ç›¸åŒé» (è¡¨é¢åŠŸèƒ½)
- éƒ½æ˜¯ PyTorch Lightning DataModule
- éƒ½è™•ç†äº¤é€šè³‡æ–™è¼‰å…¥
- éƒ½æä¾› train/val/test DataLoader
- éƒ½æ”¯æ´æ‰¹æ¬¡è™•ç†

### é—œéµå·®ç•° (æ¶æ§‹æœ¬è³ª)

| ç¶­åº¦ | TrafficDataModule (ç¾æœ‰) | DistributedTrafficDataModule (è¨ˆåŠƒ) |
|------|-------------------------|----------------------------------|
| **è¼¸å‡ºæ ¼å¼** | æ¨™æº–å¼µé‡ `[B, T, N, F]`* | VD å­—å…¸ `{vd_id: tensor}` |
| **æ¶æ§‹ç›®æ¨™** | é›†ä¸­å¼è™•ç† | åˆ†æ•£å¼è™•ç† |
| **VD è™•ç†** | æ‰€æœ‰ VD åˆä½µåœ¨ä¸€å€‹å¼µé‡ | æ¯å€‹ VD ç¨ç«‹å¼µé‡ |
| **ä¸‹æ¸¸æ¨¡å‹** | æ¨™æº– LSTM/xLSTM | VDXLSTMManager |
| **è¨˜æ†¶é«”ç­–ç•¥** | å…¨éƒ¨è¼‰å…¥ | é¸æ“‡æ€§è¼‰å…¥ |

> *å¼µé‡ç¶­åº¦å®šç¾©: **B**=Batch (æ‰¹æ¬¡), **T**=Time (æ™‚é–“æ­¥), **N**=Nodes (VDæ•¸é‡), **F**=Features (ç‰¹å¾µç¶­åº¦)

---

## ğŸ’» ç¨‹å¼ç¢¼å·®ç•°ç¯„ä¾‹

### TrafficDataModule è¼¸å‡º
```python
batch = {
    'input_seq': Tensor[B, T, N, F],     # B=æ‰¹æ¬¡, T=æ™‚é–“æ­¥, N=VDæ•¸é‡, F=ç‰¹å¾µç¶­åº¦
    'target_seq': Tensor[B, T, N, F],    # æ‰€æœ‰ VD åˆä½µåœ¨æ¨™æº–å¼µé‡ä¸­
    'input_mask': Tensor[B, T, N],       # å°æ‡‰çš„é®ç½©å¼µé‡
    'vdids': List[str]                   # åƒ…ä½œç‚º metadata
}

# ä¸‹æ¸¸ä½¿ç”¨
model.forward(batch['input_seq'])  # ç›´æ¥è™•ç†æ•´å€‹å¼µé‡
```

### DistributedTrafficDataModule è¼¸å‡º  
```python
batch = {
    'features': {                        # VD å­—å…¸çµæ§‹
        'VD-001': Tensor[B, T, F],       # B=æ‰¹æ¬¡, T=æ™‚é–“æ­¥, F=ç‰¹å¾µç¶­åº¦ (æ¯å€‹VDç¨ç«‹)
        'VD-002': Tensor[B, T, F],       # N ç¶­åº¦è¢«åˆ†è§£åˆ°å­—å…¸ keys ä¸­
        'VD-003': Tensor[B, T, F]
    },
    'targets': {
        'VD-001': Tensor[B, T, F],       # ç›®æ¨™å¼µé‡åŒæ¨£æŒ‰ VD åˆ†çµ„
        'VD-002': Tensor[B, T, F], 
        'VD-003': Tensor[B, T, F]
    }
}

# ä¸‹æ¸¸ä½¿ç”¨
hidden_states = vd_manager.forward(batch['features'])  # å­—å…¸è™•ç† {vd_id: Tensor[B,T,H]}
social_context = social_pooling(hidden_states)         # per-VD ç¤¾äº¤èšåˆ
```

---

## ğŸ—ï¸ æ¶æ§‹å·®ç•°èªªæ˜

### é›†ä¸­å¼æ¶æ§‹ (ç¾æœ‰)
```
æ‰€æœ‰VDè³‡æ–™ â†’ [å¤§å¼µé‡] â†’ å–®ä¸€æ¨¡å‹ â†’ é æ¸¬
```

### åˆ†æ•£å¼æ¶æ§‹ (è¨ˆåŠƒ)
```
VD-A â†’ ç¨ç«‹å¼µé‡ â†’ xLSTM-A â†’ éš±ç‹€æ…‹-A â”
VD-B â†’ ç¨ç«‹å¼µé‡ â†’ xLSTM-B â†’ éš±ç‹€æ…‹-B â”œâ†’ Social Pooling â†’ èåˆé æ¸¬
VD-C â†’ ç¨ç«‹å¼µé‡ â†’ xLSTM-C â†’ éš±ç‹€æ…‹-C â”˜
```

---

## âš¡ ç‚ºä»€éº¼éœ€è¦å…©ç¨®ä¸åŒçš„ DataModuleï¼Ÿ

### 1. **Social Pooling éœ€æ±‚**
- åˆ†æ•£å¼æ¶æ§‹éœ€è¦ per-VD éš±ç‹€æ…‹ä¾†è¨ˆç®—ç¤¾äº¤ç‰¹å¾µ
- é›†ä¸­å¼ç„¡æ³•æä¾›ç¨ç«‹çš„éš±ç‹€æ…‹

### 2. **xLSTM ä¸¦è¡Œè™•ç†**
- æ¯å€‹ VD éœ€è¦ç¨ç«‹çš„ xLSTM å¯¦ä¾‹
- VDXLSTMManager éœ€è¦å­—å…¸æ ¼å¼è¼¸å…¥

### 3. **è¨˜æ†¶é«”æ•ˆç‡**
- å¯ä»¥é¸æ“‡æ€§è¼‰å…¥ç‰¹å®š VD çš„è³‡æ–™
- æ”¯æ´å‹•æ…‹ VD çµ„åˆ

### 4. **æ¶æ§‹é·ç§»**
- å¾éŒ¯èª¤çš„é›†ä¸­å¼æ¶æ§‹é·ç§»åˆ°æ­£ç¢ºçš„åˆ†æ•£å¼æ¶æ§‹
- å…©è€…ä¸èƒ½äº’æ›ä½¿ç”¨

---

## ğŸ¯ é¡æ¯”èªªæ˜

**å°±åƒé¤å»³æœå‹™æ¨¡å¼**ï¼š
- **TrafficDataModule** = æ™®é€šé¤å»³ (å»šå¸«çµ±ä¸€æº–å‚™ï¼Œä¸€èµ·ä¸Šèœ)
- **DistributedTrafficDataModule** = è‡ªåŠ©é¤å»³ (æ¯å€‹å€åŸŸç¨ç«‹ï¼Œå®¢äººé¸æ“‡çµ„åˆ)

éƒ½æä¾›é£Ÿç‰©ï¼Œä½†æœå‹™æ¨¡å¼å®Œå…¨ä¸åŒã€‚

---

## ğŸ“ å¯¦æ–½ç‹€æ…‹

| æ¨¡çµ„ | ç‹€æ…‹ | æª”æ¡ˆä½ç½® |
|------|------|----------|
| TrafficDataModule | âœ… å·²å¯¦ç¾ | `src/social_xlstm/dataset/core/datamodule.py` |
| DistributedTrafficDataModule | â³ è¨ˆåŠƒä¸­ | `src/social_xlstm/data/distributed_datamodule.py` (todo.md Task 1.2) |

---

## âš ï¸ é‡è¦æé†’

**ä¸æ˜¯åŠŸèƒ½é‡è¤‡ï¼**  
é€™æ˜¯ç‚ºäº†æ”¯æ´ä¸åŒæ¶æ§‹æ¨¡å¼çš„å¿…è¦åŸºç¤è¨­æ–½å·®ç•°ã€‚å°±åƒ TCP å’Œ UDP éƒ½æ˜¯ç¶²è·¯å”å®šï¼Œä½†ä½¿ç”¨å ´æ™¯å®Œå…¨ä¸åŒã€‚

---

**åƒè€ƒè³‡æ–™**ï¼š
- `todo.md` Task 1.2: å»ºç«‹ DistributedTrafficDataModule
- åˆ†æ•£å¼ Social-xLSTM æ¶æ§‹è¨­è¨ˆ (ADR-0100)
- VDXLSTMManager è¨­è¨ˆè¦ç¯„
- [`docs/architecture/data_pipeline.md`](../architecture/data_pipeline.md) â€• æ•¸æ“šæµç¨‹æ¶æ§‹èˆ‡åˆ‡ç‰‡ç­–ç•¥è©³è§£