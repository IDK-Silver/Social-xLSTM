# äº¤é€šè³‡æ–™æ ¼å¼èªªæ˜

## æ¦‚è¿°

æœ¬å°ˆæ¡ˆä½¿ç”¨å°ç£äº¤é€šéƒ¨æä¾›çš„è»Šè¼›åµæ¸¬å™¨ (VD, Vehicle Detector) è³‡æ–™ï¼ŒåŒ…å«å³æ™‚äº¤é€šæµé‡ã€é€Ÿåº¦ã€ä½”æœ‰ç‡ç­‰è³‡è¨Šã€‚

## è³‡æ–™ä¾†æºçµæ§‹

### åŸå§‹è³‡æ–™æ ¼å¼
```
ZIP å£“ç¸®æª” â†’ XML æª”æ¡ˆ â†’ JSON æ ¼å¼ â†’ HDF5 æ ¼å¼
```

### æ™‚é–“æˆ³è¨˜ç›®éŒ„çµæ§‹
```
blob/dataset/pre-processed/unzip_to_json/
â”œâ”€â”€ 2025-03-18_00-49-00/
â”‚   â”œâ”€â”€ VDList.json          # VD å…ƒè³‡æ–™ (åº§æ¨™ã€è»Šé“æ•¸ç­‰)
â”‚   â””â”€â”€ VDLiveList.json      # VD å³æ™‚äº¤é€šè³‡æ–™
â”œâ”€â”€ 2025-03-18_00-50-00/
â””â”€â”€ ...
```

## JSON è³‡æ–™çµæ§‹

### VDList.json (VD å…ƒè³‡æ–™)
```json
{
  "UpdateInfo": {...},
  "VDList": [
    {
      "VDID": "VD-11-0020-002-001",
      "PositionLon": 121.459501,
      "PositionLat": 25.149709,
      "RoadID": "300020",
      "RoadName": "è‡º2ç·š",
      "LaneNum": 3
    }
  ]
}
```

### VDLiveList.json (å³æ™‚äº¤é€šè³‡æ–™)
```json
{
  "LiveTrafficData": [
    {
      "VDID": "VD-11-0020-002-001",
      "DataCollectTime": "2025-03-18T00:46:11+08:00",
      "UpdateInterval": 60,
      "AuthorityCode": "THB",
      "LinkFlows": [                    // ğŸ“ é—œéµï¼šè³‡æ–™åœ¨é€™è£¡
        {
          "LinkID": "3000200000176F",
          "Lanes": [                    // ğŸ“ æ¯å€‹ Link åŒ…å«å¤šå€‹ Lanes
            {
              "LaneID": 0,
              "LaneType": 1,
              "Speed": 59.0,            // é€Ÿåº¦ (km/h)
              "Occupancy": 1.0,         // ä½”æœ‰ç‡ (%)
              "Vehicles": [             // ğŸ“ è»Šè¼›è³‡æ–™æŒ‰è»Šå‹åˆ†é¡
                {
                  "VehicleType": "L",   // L=å¤§å‹è»Š, S=å°å‹è»Š
                  "Volume": 0           // è©²è»Šå‹çš„æµé‡
                },
                {
                  "VehicleType": "S",
                  "Volume": 1
                }
              ]
            }
          ]
        }
      ]
    }
  ]
}
```

## è³‡æ–™è·¯å¾‘è§£æ

### æ­£ç¢ºçš„è³‡æ–™å­˜å–è·¯å¾‘
```
VD â†’ LinkFlows â†’ [LinkID] â†’ Lanes â†’ [LaneID] â†’ Speed/Occupancy/Vehicles
```

### ç¨‹å¼ç¢¼ç¯„ä¾‹
```python
for vd in vd_live_list.LiveTrafficData:
    print(f"VD ID: {vd.VDID}")
    
    for link_flow in vd.LinkFlows:
        print(f"  Link ID: {link_flow.LinkID}")
        
        for lane in link_flow.Lanes:
            print(f"    Lane {lane.LaneID}: Speed={lane.Speed}, Occ={lane.Occupancy}")
            
            for vehicle in lane.Vehicles:
                print(f"      {vehicle.VehicleType}: {vehicle.Volume} è¼›")
```

## éŒ¯èª¤ç¢¼èˆ‡ç•°å¸¸å€¼

### å¸¸è¦‹éŒ¯èª¤ç¢¼
| éŒ¯èª¤ç¢¼ | å«ç¾© | è™•ç†æ–¹å¼ |
|--------|------|----------|
| `-99` | æ„Ÿæ¸¬å™¨æ•…éšœæˆ–è³‡æ–™ç¼ºå¤± | è½‰æ›ç‚º NaN |
| `-1` | åˆå§‹åŒ–éŒ¯èª¤æˆ–æœªçŸ¥ç‹€æ…‹ | è½‰æ›ç‚º NaN |
| `255` | æ•¸å€¼æº¢å‡ºæˆ–ç³»çµ±éŒ¯èª¤ | è½‰æ›ç‚º NaN |
| `0` | å¯èƒ½æ˜¯çœŸå¯¦é›¶å€¼æˆ–ç„¡è»Šè¼› | ä¿ç•™ (éœ€ä¸Šä¸‹æ–‡åˆ¤æ–·) |

### ç•°å¸¸å€¼æª¢æ¸¬è¦å‰‡
```python
def is_valid_traffic_value(value, feature_type):
    if value is None or np.isnan(value):
        return False
    
    # éŒ¯èª¤ç¢¼éæ¿¾
    if value in [-99, -1, 255]:
        return False
    
    # ç¯„åœæª¢æŸ¥
    if feature_type == 'speed':
        return 0 <= value <= 200      # km/h
    elif feature_type == 'occupancy':
        return 0 <= value <= 100      # %
    elif feature_type == 'volume':
        return value >= 0             # éè² æ•¸
    
    return True
```

## ç‰¹å¾µå®šç¾©

### æå–çš„äº¤é€šç‰¹å¾µ
| ç‰¹å¾µåç¨± | è‹±æ–‡åç¨± | è¨ˆç®—æ–¹å¼ | æ­£å¸¸ç¯„åœ | å–®ä½ |
|----------|----------|----------|----------|------|
| å¹³å‡é€Ÿåº¦ | `avg_speed` | æ‰€æœ‰è»Šé“é€Ÿåº¦çš„å¹³å‡å€¼ | 0-200 | km/h |
| ç¸½æµé‡ | `total_volume` | æ‰€æœ‰è»Šé“æ‰€æœ‰è»Šå‹æµé‡ç¸½å’Œ | â‰¥0 | è¼›/åˆ†é˜ |
| å¹³å‡ä½”æœ‰ç‡ | `avg_occupancy` | æ‰€æœ‰è»Šé“ä½”æœ‰ç‡çš„å¹³å‡å€¼ | 0-100 | % |
| é€Ÿåº¦æ¨™æº–å·® | `speed_std` | å„è»Šé“é€Ÿåº¦çš„æ¨™æº–å·® | â‰¥0 | km/h |
| è»Šé“æ•¸ | `lane_count` | è©² VD çš„æœ‰æ•ˆè»Šé“ç¸½æ•¸ | 1-10 | å€‹ |

### èšåˆè¦å‰‡
```python
# å–®ä¸€ VD å¯èƒ½æœ‰å¤šå€‹ LinkFlowsï¼Œæ¯å€‹ LinkFlow æœ‰å¤šå€‹ Lanes
all_lanes = []
for link_flow in vd.LinkFlows:
    all_lanes.extend(link_flow.Lanes)

# ç‰¹å¾µè¨ˆç®—
avg_speed = np.mean([lane.Speed for lane in all_lanes if is_valid(lane.Speed)])
total_volume = np.sum([sum(v.Volume for v in lane.Vehicles) for lane in all_lanes])
```

## è³‡æ–™å“è³ªæŒ‡æ¨™

### é æœŸçš„è³‡æ–™å“è³ª
| æŒ‡æ¨™ | æ­£å¸¸ç¯„åœ | èªªæ˜ |
|------|----------|------|
| VD åŒ¹é…ç‡ | 80-90% | VDList èˆ‡ VDLiveList çš„ ID åŒ¹é…æ¯”ä¾‹ |
| æœ‰æ•ˆè³‡æ–™æ¯”ä¾‹ | 60-90% | éæ¿¾éŒ¯èª¤ç¢¼å¾Œçš„æœ‰æ•ˆæ•¸å€¼æ¯”ä¾‹ |
| NaN æ¯”ä¾‹ | 10-40% | åŒ…å«éŒ¯èª¤ç¢¼éæ¿¾å’Œç¼ºå¤±è³‡æ–™ |
| æ™‚é–“è¦†è“‹ç‡ | >95% | é€£çºŒæ™‚é–“æ­¥çš„è³‡æ–™å®Œæ•´æ€§ |

### è³‡æ–™å“è³ªæª¢æŸ¥ç¯„ä¾‹
```python
def check_data_quality(h5_file_path):
    with h5py.File(h5_file_path, 'r') as f:
        features = f['data/features']
        
        # è¨ˆç®—å„ç‰¹å¾µçš„æœ‰æ•ˆç‡
        for i, feature_name in enumerate(['avg_speed', 'total_volume', ...]):
            feature_data = features[:, :, i]
            valid_ratio = np.sum(~np.isnan(feature_data)) / feature_data.size
            print(f"{feature_name}: {valid_ratio:.1%} æœ‰æ•ˆ")
```

## å¸¸è¦‹å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ

### Q1: ç‚ºä»€éº¼ VD åŒ¹é…ç‡ä¸æ˜¯ 100%ï¼Ÿ
**A**: æ­£å¸¸ç¾è±¡ã€‚åŸå› åŒ…æ‹¬ï¼š
- éƒ¨åˆ† VD åœ¨ç‰¹å®šæ™‚æ®µå¯èƒ½ç„¡è³‡æ–™ï¼ˆç¶­è­·ã€æ•…éšœç­‰ï¼‰
- VDList åŒ…å«æ‰€æœ‰å·²è¨»å†Šçš„ VDï¼Œä½†ä¸æ˜¯æ‰€æœ‰éƒ½å¯¦æ™‚é‹ä½œ
- VDLiveList å¯èƒ½åŒ…å«æ¸¬è©¦ä¸­çš„æ–° VDï¼Œå°šæœªåŠ å…¥æ­£å¼æ¸…å–®

### Q2: ç‚ºä»€éº¼æœ‰é€™éº¼å¤š NaN å€¼ï¼Ÿ
**A**: ä¸»è¦åŸå› ï¼š
- éŒ¯èª¤ç¢¼éæ¿¾ï¼ˆ-99, 255 ç­‰ï¼‰
- æ„Ÿæ¸¬å™¨æ•…éšœæˆ–ç¶­è­·æœŸé–“
- ç‰¹å®šæ™‚æ®µäº¤é€šé‡æ¥µä½ï¼ˆå¦‚æ·±å¤œï¼‰
- æ–°å»ºæˆ–é™¤å½¹ä¸­çš„ VD

### Q3: Speed ç‚º 0 æ˜¯æ­£å¸¸çš„å—ï¼Ÿ
**A**: éœ€è¦åˆ¤æ–·ï¼š
- å¦‚æœ Volume ä¹Ÿç‚º 0ï¼šå¯èƒ½æ˜¯çœŸå¯¦çš„ç„¡è»Šç‹€æ…‹
- å¦‚æœ Volume > 0 ä½† Speed = 0ï¼šå¯èƒ½æ˜¯å¡è»Šæˆ–æ„Ÿæ¸¬å™¨ç•°å¸¸
- å»ºè­°çµåˆ Occupancy ä¸€èµ·åˆ¤æ–·

### Q4: å¦‚ä½•è™•ç†è»Šé“æ•¸ä¸ä¸€è‡´ï¼Ÿ
**A**: 
- VDList ä¸­çš„ LaneNum æ˜¯ç†è«–è»Šé“æ•¸
- å¯¦éš› LinkFlows ä¸­çš„ Lanes æ˜¯ç•¶å‰é‹ä½œçš„è»Šé“æ•¸
- å»ºè­°ä½¿ç”¨å¯¦éš›é‹ä½œçš„è»Šé“æ•¸ä½œç‚ºç‰¹å¾µ

## è³‡æ–™ä½¿ç”¨å»ºè­°

### æ¨¡å‹è¨“ç·´å‰è™•ç†
1. **éŒ¯èª¤ç¢¼éæ¿¾**: ç§»é™¤ -99, -1, 255 ç­‰éŒ¯èª¤å€¼
2. **ç•°å¸¸å€¼æª¢æ¸¬**: æª¢æŸ¥è¶…å‡ºåˆç†ç¯„åœçš„æ•¸å€¼
3. **ç¼ºå¤±å€¼è™•ç†**: æ ¹æ“šæ¨¡å‹éœ€æ±‚æ±ºå®šæ’å€¼æˆ–é®ç½©ç­–ç•¥
4. **æ­£è¦åŒ–**: å„ç‰¹å¾µä½¿ç”¨é©ç•¶çš„æ­£è¦åŒ–æ–¹æ³•
5. **æ™‚é–“å°é½Š**: ç¢ºä¿æ™‚é–“æˆ³è¨˜çš„ä¸€è‡´æ€§

### ç©ºé–“åˆ†æå»ºè­°
- ä½¿ç”¨ VD çš„ç¶“ç·¯åº¦åº§æ¨™é€²è¡Œç©ºé–“ç›¸é—œæ€§åˆ†æ
- è€ƒæ…®é“è·¯ç¶²çµ¡çµæ§‹ï¼ˆç›¸åŒ RoadID çš„ VD å¯èƒ½ç›¸é—œï¼‰
- æ³¨æ„ä¸åŒæ–¹å‘çš„è»Šé“å¯èƒ½æœ‰ä¸åŒçš„ LinkID

### æ™‚é–“åºåˆ—åˆ†æ
- è³‡æ–™æ›´æ–°é–“éš”é€šå¸¸ç‚º 1-5 åˆ†é˜
- è€ƒæ…®äº¤é€šçš„é€±æœŸæ€§æ¨¡å¼ï¼ˆå°æ™‚ã€æ—¥ã€é€±ï¼‰
- æ³¨æ„ç¯€å‡æ—¥å’Œç‰¹æ®Šäº‹ä»¶çš„å½±éŸ¿

## ç›¸é—œæ–‡æª”

- [H5 è½‰æ›å™¨ä½¿ç”¨æŒ‡å—](../scripts/dataset/pre-process/README_h5_converter.md)
- [æ¨¡å‹è¨“ç·´æŒ‡å—](./guides/training_scripts_guide.md)
- [åº§æ¨™ç³»çµ±èªªæ˜](./spatial_coords.md)